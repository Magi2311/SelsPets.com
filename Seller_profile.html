<html>
    <head>
        {% include 'header.html' %}
    </head>

    <body style="background-color: antiquewhite;" id="blurred">
        <section class="sub-header" style="height:auto;">           
                {% include 'Menu_seller.html' %}
                <h1>–ú–æ—è –ø—Ä–æ—Ñ–∏–ª</h1>
            </section>
        </section>
        <form action="/edit-profile" method="POST" enctype="multipart/form-data" id="profileForm">
        <section class="profile-section">
            <div class="Information">
                    <div class="picProfile">
                        <label for="profileImage">
                            <img
                            id="profilePreview"
                            src="{{ url_for('profile_picture', user_id=session['user_id']) }}"
                            alt="–ü—Ä–æ—Ñ–∏–ª–Ω–∞ —Å–Ω–∏–º–∫–∞">
                            <div class="upload-overlay">
                            <i class="bx bx-camera"></i>
                            </div>
                        </label>   
                        <!--–ü–æ–ª–µ—Ç–æ –∑–∞ –∫–∞—á–≤–∞–Ω–µ –Ω–∞ —Å–Ω–∏–º–∫–∞-->
                        <input type="file" id="profileImage" name ="profile_picture" style="display: none;" accept="image/*"> 
                    </div>
                    <p style="margin-left: -10px;"> *–ù–∞—Ç–∏—Å–Ω–µ—Ç–µ —Å–Ω–∏–∫–∞—Ç–∞ –∑–∞ –¥–∞ —è –ø—Ä–æ–º–µ–Ω–∏—Ç–µ</p>
                    <div class="two-form">
                        <div class="input-box">
                            <input  type="text" class="input-field edit-text" placeholder="–ò–º–µ" name="first_name" pattern="^[–ê-–Ø–∞-—èA-Za-z\s\-]+$" value=" {{ profile.first_name }}">
                            <i class="bx bx-user"></i>
                        </div>
                        <div class="input-box">
                            <input  type="text" class="input-field edit-text" placeholder="–§–∞–º–∏–ª–∏—è" name="last_name" pattern="^[–ê-–Ø–∞-—èA-Za-z\s\-]+$" value="{{ profile.last_name }}">
                            <i class="bx bx-user"></i>
                        </div>
                    </div>
                    </div>

                <div class="personalInf">
                    <div class="input-box">
                        <input  type="email" class="input-field edit-text" placeholder="–ò–º–µ–π–ª" name="email" value="{{ user.email }}">
                        <i class="bx bx-envelope"></i>
                    </div>

                    <div class="input-box">
                        <input  type="text" class="input-field edit-text" placeholder="–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ" name="username" value="{{ profile.username }}">
                        <i class="bx bx-envelope"></i>
                    </div>

                    <div class="input-box">
                        <input
                            id="phoneField"
                            type="tel"
                            class="input-field edit-text"
                            placeholder="–¢–µ–ª–µ—Ñ–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä"
                            pattern="^\+359[0-9]{9}$"
                            oninput="limitDigits(event)"
                            title="–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ç–æ–∑–∏ —Ñ–æ—Ä–º–∞—Ç: +359XXXXXXXXX"
                            name="phone"
                            value="{{ '+359' + profile.phone[1:] if profile.phone.startswith('0') else profile.phone }}"
                            >
                        <i class="bx bxs-phone"></i>
                    </div>
                    <div class="input-box">
                        <input type="date" id="birth_date" class="input-field edit-text" name="birth_date" value="{{ profile.birth_date }}">
                        <i class="bx bxs-face"></i>
                    </div>         
                </div>
                <div class="ContactInf">
                    <div class="input-box">
                        <input id="city" type="text" class="input-field edit-text" placeholder="–ì—Ä–∞–¥" maxlength="20" name="city" value="{{ profile.city }}">
                        <i class="bx bx-navigation"></i>
                    </div>
                    <div class="input-box">
                        <input id="postalCode" type="text" class="input-field edit-text" placeholder="–ü–æ—â.–∫–æ–¥" maxlength="4" name="postal_code" value="{{ profile.postal_code }}">
                        <i class="bx bx-navigation"></i>
                    </div>
                    <div class="input-box">
                    <input name="new_password" type="password" class="input-field edit-text" placeholder="–ù–æ–≤–∞ –ø–∞—Ä–æ–ª–∞">
                    <i class="bx bx-lock-alt"></i>
                    <span id="togglePassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">üëÅÔ∏è</span>
                    </div>
                    <div class="input-box">
                    <input name="confirm_password" type="password" class="input-field edit-text" placeholder="–ü–æ—Ç–≤—ä—Ä–¥–∏ –ø–∞—Ä–æ–ª–∞—Ç–∞">
                    <i class="bx bx-lock-alt"></i>
                    <span id="togglePassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">üëÅÔ∏è</span>
                    </div>
                </div>
            </section>

            <section class="ButSave">
                <div class="input-box">
                    <button type="button" id="editProfileBtn" class="submit">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
                </div>
                <div class="input-box">
                    <button type="submit" id="saveProfileBtn" class="submit hidden">–ó–∞–ø–∞–∑–∏</button>
                </div>
            </section>
        </section>
        </form>
        <section class="petsInf">

        <h2 style="
        text-align: center;
        font-size: 50px;
        margin-top: 20px;margin-bottom: 20px;">
        –ú–æ–∏—Ç–µ –æ–±—è–≤–∏

        <a href="#" class="hero" id="openModalBtn" onclick="openModal()"style=
        "display: flex;
        justify-self: self-end;
        background-color: #005f00d1; text-decoration: none; 
        padding: 10px 20px; color: white; border-radius: 8px;">
        –î–æ–±–∞–≤–∏ –æ–±—è–≤–∞
        </a>
<!-- –ú–æ–¥–∞–ª -->
    <form action="{{ url_for('add_pet') }}" method="POST" enctype="multipart/form-data" id="petForm">
        <div class="modal" id="myModal">
            <div class="form-container">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2 style="border-bottom: 1px solid black; font-size: 32px; text-align: center;">–î–æ–±–∞–≤–∏ –æ–±—è–≤–∞</h2>
                
                <div class="input-box">
                    <h6>–í–∏–¥ –∂–∏–≤–æ—Ç–Ω–æ:</h6>
                    <label><input type="radio" name="type_name" value="–ö—É—á–µ"> –ö—É—á–µ</label>
                    <label><input type="radio" name="type_name" value="–ö–æ—Ç–∫–∞"> –ö–æ—Ç–∫–∞</label>
                    <label><input type="radio" name="type_name" value="–ü—Ç–∏—Ü–∞"> –ü—Ç–∏—Ü–∞</label>
                    <label><input type="radio" name="type_name" value="–•–∞–º—Å—Ç–µ—Ä"> –•–∞–º—Å—Ç–µ—Ä</label>
                    <label><input type="radio" name="type_name" value="–î—Ä—É–≥–æ"> –î—Ä—É–≥–æ</label>
                </div>
                
                <div class="input-box">
                    <h6>–ü–æ—Ä–æ–¥–∞:</h6>
                    <input type="text"id="breed-name" name="breed_name" class="input-field" pattern="^[–ê-–Ø–∞-—èA-Za-z\s\-]+$" placeholder="-"required>
                </div>
                <div class="input-box">
                    <h6>–í—ä–∑—Ä–∞—Å—Ç:</h6>
                    <label><input type="checkbox" id="underOneYear" onclick="toggleUnderOneYear()"> –ü–æ-–º–∞–ª–∫–æ –æ—Ç –≥–æ–¥–∏–Ω–∞</label>
                    <input type="number" id="ageInput" name="age" class="input-field" placeholder="–í—ä–∑—Ä–∞—Å—Ç –≤ –≥–æ–¥–∏–Ω–∏" min="0" oninput="validateNumberInput(this)" required>
                </div>

                <div class="input-box">
                    <h6>–ü–æ–ª:</h6>
                    <select name="gender">
                        <option value="–º—ä–∂–∫–∏">–º—ä–∂–∫–∏</option>
                        <option value="–∂–µ–Ω—Å–∫–∏">–∂–µ–Ω—Å–∫–∏</option>
                    </select>
                </div>

                <div class="input-box">
                    <h6>–°–Ω–∏–º–∫–∞:</h6>
                    <input type="file" id="petImage" class="input-field" accept="image/*" name="pet_picture"  required>
                </div>

                <div class="input-box">
                    <h6>–í–∞–∫—Å–∏–Ω–∞—Ü–∏—è:</h6>
                    <select name="vaccinated">
                        <option value="–¥–∞"> –î–∞</option>
                        <option value="–Ω–µ"> –ù–µ</option>
                    </select>
                </div>

                <div class="input-box">
                    <h6>–¶–µ–Ω–∞:</h6>
                    <input type="number" name="price" id="priceInput" class="input-field" placeholder="–¶–µ–Ω–∞ –≤ –ª–≤." min="0" required>
                </div>

                <div class="input-box">
                    <h6>–û–ø–∏—Å–∞–Ω–∏–µ:</h6>
                    <textarea id="description" name="description" class="input-field" rows="5" style="resize: vertical;" required></textarea>
                </div>

                <button class="hero" type="button" onclick="openConfirmModal()">–ü—É–±–ª–∏–∫—É–≤–∞–π</button>
            </div>
        </div>
            <div id="confirmModal" class="modal">
                <div class="form-container">
                    <h3>–ü–æ—Ç–≤—ä—Ä–¥–∏ –ø—É–±–ª–∏–∫—É–≤–∞–Ω–µ</h3>
                    <p>–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –ø—É–±–ª–∏–∫—É–≤–∞—Ç–µ –æ–±—è–≤–∞—Ç–∞?</p>
                    <button class="confirm-btn" onclick="submitForm()">–î–∞, –ø—É–±–ª–∏–∫—É–≤–∞–π</button>
                    <button class="cancel-btn" onclick="closeConfirmModal()">–ù–µ, –∞–Ω—É–ª–∏—Ä–∞–π</button>
                </div>
            </div>
            
    </form>
    <div class="ads-list" id="ads-container">
    {% for ad in ads %}
    <form id="petForm-{{ ad.pet_id }}"class="ad-item-form">
        <div class="ad-item">
            <h3><span class="text" data-field="title">–û–±—è–≤–∞ –Ω–æ–º–µ—Ä: {{ loop.index }} 
                <br>
                (ID: {{ ad.pet_id }})</span></h3>
            <div class="ad-item1">
                <div class="ad-image">
                    <img src="{{ url_for('pet_picture', pet_id=ad.pet_id) }}" alt="–ñ–∏–≤–æ—Ç–Ω–æ" style="margin: 0%; padding: 0%; object-fit: cover;" />
                </div>
                    <div style="text-align: left;">
                        <p>–ö–∞—á–µ–Ω–∞ –Ω–∞: <span class="ad-number not-editable" data-field="upload_date">{{ ad.upload_date}}</span></p>
                        <p>–í–∏–¥: <span class="edit-text" data-field="type_name">{{ ad.type_name }}</span></p>
                        <p>–ü–æ—Ä–æ–¥–∞: <span class="edit-text" data-field="breed_name">{{ ad.breed_name if ad.breed_name else '–ù—è–º–∞' }}</span></p>
                        <p>–í—ä–∑—Ä–∞—Å—Ç: <span class="edit-text" data-field="age">{% if ad.age == 0 %}–ü–æ-–º–∞–ª–∫–æ –æ—Ç –≥–æ–¥–∏–Ω–∞{% else %}{{ ad.age }} –≥–æ–¥–∏–Ω–∏{% endif %}</span></p>
                        <p>–¶–µ–Ω–∞: <span class="edit-text" data-field="price">{{ ad.price }} –ª–≤.</span></p>
                        <p>–õ–æ–∫–∞—Ü–∏—è: <span class="edit-text" data-field="city">{{ profile.city }}</span></p>
                        <p>–ü–æ–ª: <span class="edit-text" data-field="gender">{{ ad.gender }}</span></p>
                        <p>–í–∞–∫—Å–∏–Ω–∞—Ü–∏—è: <span class="edit-text" data-field="vaccinated">{{ ad.vaccinated }}</span></p>
                        <p>–û–ø–∏—Å–∞–Ω–∏–µ: <span class="edit-text" data-field="description">{{ ad.description }}</span></p>
                    </div>
                </div>
            <div class="ad-actions">
                <button type="button" class="edit-ad" onclick="editAd(this)" data-id="{{ ad.pet_id }}">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
                <button type="button" class="save-ad hidden" onclick="saveAd(this)" data-id="{{ ad.pet_id }}">–ó–∞–ø–∞–∑–∏</button>
                <button type="button" class="delete-ad" onclick="deleteAd(this)" data-id="{{ ad.pet_id }}" style="background-color: reds;">–ò–∑—Ç—Ä–∏–π</button>
            </div>
        </div>
    </form>
    {% endfor %}
    {% if ads|length == 0 %}
        <p>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –æ–±—è–≤–∏.</p>
    {% endif %}
    </div>
    </section>
        <section class="footer" >
            {% include 'Footer.html' %}
        </section>

        <style>
            .hidden { display: none; }
        </style>
    <script src="{{ url_for('static', filename='js/Fun.js') }}"></script>
    <script>
        
        function openModal() {
                document.getElementById('myModal').style.display = "block";
                document.getElementById("mainContent").classList.add("blurred");
            }
            function closeModal() {
                document.getElementById('myModal').style.display = "none";
                document.getElementById("mainContent").classList.remove("blurred");
            }
            function updateType() {
                document.getElementById('typeInput').value = document.querySelector('input[name="Type"]:checked').value;
            }
            function toggleUnderOneYear() {
                const ageInput = document.getElementById('ageInput');
                ageInput.disabled = document.getElementById('underOneYear').checked;
                ageInput.value = ageInput.disabled ? 0 : '';
            }
            function validateNumberInput(input) {
                input.value = input.value.replace(/[^0-9]/g, '');
            }
            function clearForm() {
                document.querySelectorAll(".input-field").forEach(input => input.value = "");
                document.querySelectorAll("input[type='radio'], input[type='checkbox']").forEach(input => input.checked = false);
            }
            
            // –û—Ç–≤–∞—Ä—è–Ω–µ –∏ –∑–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –ø–æ—Ç–≤—ä—Ä–¥–∏—Ç–µ–ª–Ω–∏—è –º–æ–¥–∞–ª
            function openConfirmModal() {
                document.getElementById('confirmModal').style.display = "block";
            }

            function closeConfirmModal() {
                document.getElementById('confirmModal').style.display = "none";
            }

            function submitForm() {
                closeConfirmModal();
                alert("–û–±—è–≤–∞—Ç–∞ –±–µ—à–µ —É—Å–ø–µ—à–Ω–æ –ø—É–±–ª–∏–∫—É–≤–∞–Ω–∞! üéâ");
                document.getElementById("petForm").submit();
            }

            function validateEditForm(data) {
                // –í–ò–î
                if (!data.type_name || !['–ö—É—á–µ', '–ö–æ—Ç–∫–∞', '–ü—Ç–∏—Ü–∞', '–•–∞–º—Å—Ç–µ—Ä', '–î—Ä—É–≥–æ'].includes(data.type_name)) {
                    alert('–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω –≤–∏–¥ –∂–∏–≤–æ—Ç–Ω–æ');
                    return false;
                }

                // –ü–û–†–û–î–ê
                if (!data.breed_name || data.breed_name.trim() === '') {
                    alert('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –ø–æ—Ä–æ–¥–∞');
                    return false;
                }

                // –ì–û–î–ò–ù–ò
                const age = parseInt(data.age);
                if (isNaN(age) || age < 0) {
                    alert('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–Ω–∞ –≤—ä–∑—Ä–∞—Å—Ç');
                    return false;
                }

                // –¶–ï–ù–ê
                const price = parseFloat(data.price);
                if (isNaN(price) || price < 0) {
                    alert('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–Ω–∞ —Ü–µ–Ω–∞');
                    return false;
                }

                // –ü–û–õ
                if (!data.gender || !['–º—ä–∂–∫–∏', '–∂–µ–Ω—Å–∫–∏'].includes(data.gender)) {
                    alert('–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω –ø–æ–ª');
                    return false;
                }

                // –í–ê–ö–°–ò–ù–ê–¶–ò–Ø
                if (!data.vaccinated || !['–¥–∞', '–Ω–µ'].includes(data.vaccinated)) {
                    alert('–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω —Å—Ç–∞—Ç—É—Å –Ω–∞ –≤–∞–∫—Å–∏–Ω–∞—Ü–∏—è');
                    return false;
                }

                // –û–ü–ò–°–ê–ù–ò–ï
                if (!data.description || data.description.trim() === '') {
                    alert('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ');
                    return false;
                }

                return true;
            }

            // –†–ï–î–ê–ö–¢–ò–†–ê–ù–ï –ù–ê –î–ê–ù–ù–ò–¢–ï –ù–ê –û–ë–Ø–í–ò–¢–ï 
            function editAd(button) {
                const adItem = button.closest('.ad-item');
                const spans = adItem.querySelectorAll('.edit-text');
                
                spans.forEach(span => {
                    const value = span.textContent.trim();
                    const field = span.getAttribute('data-field');
                    let input;

                    if (field === 'type_name') {
                        input = document.createElement('select');
                        ['–ö—É—á–µ', '–ö–æ—Ç–∫–∞', '–ü—Ç–∏—Ü–∞', '–•–∞–º—Å—Ç–µ—Ä', '–î—Ä—É–≥–æ'].forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type;
                            if (type === value) option.selected = true;
                            input.appendChild(option);
                        });
                    } else if (field === 'gender') {
                        input = document.createElement('select');
                        ['–º—ä–∂–∫–∏', '–∂–µ–Ω—Å–∫–∏'].forEach(gender => {
                            const option = document.createElement('option');
                            option.value = gender;
                            option.textContent = gender;
                            if (gender === value) option.selected = true;
                            input.appendChild(option);
                        });
                    } else if (field === 'vaccinated') {
                        input = document.createElement('select');
                        ['–¥–∞', '–Ω–µ'].forEach(status => {
                            const option = document.createElement('option');
                            option.value = status;
                            option.textContent = status;
                            if (status === value) option.selected = true;
                            input.appendChild(option);
                        });
                    } else if (field === 'age') {
                        input = document.createElement('input');
                        input.type = 'number';
                        input.min = '0';
                        input.value = value.replace(/[^0-9]/g, '');
                    } else if (field === 'price') {
                        input = document.createElement('input');
                        input.type = 'number';
                        input.min = '0';
                        input.value = value.replace(/[^0-9.]/g, '');
                    } else {
                        input = document.createElement('input');
                        input.type = 'text';
                        input.value = value;
                    }

                    input.className = 'edit-input';
                    input.setAttribute('data-field', field);
                    span.replaceWith(input);
                });

                button.classList.add('hidden');
                adItem.querySelector('.save-ad').classList.remove('hidden');
            }

            // –ó–ê–ü–ê–ó–í–ê–ù–ï –ù–ê –ù–û–í–ò–¢–ï –î–ê–ù–ù–ò
            function saveAd(button) {
                const adItem = button.closest('.ad-item');
                const petId = button.getAttribute('data-id');
                const inputs = adItem.querySelectorAll('.edit-input');
                
                const data = {};
                inputs.forEach(input => {
                    const field = input.getAttribute('data-field');
                    data[field] = input.value.trim();
                });

                // Validate the form data
                if (!validateEditForm(data)) {
                    return;
                }

                fetch(`/pets/update/${petId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.error || '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ');
                });
            }

            // –ò–ó–¢–†–ò–í–ê–ù–ï –ù–ê –û–ë–Ø–í–ê
            function deleteAd(button) {
                if (!confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–∞–∑–∏ –æ–±—è–≤–∞?')) {
                    return;
                }

                const petId = button.getAttribute('data-id');
                
                fetch(`/ads/delete/${petId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        button.closest('.ad-item-form').remove();
                        location.reload();
                    } else {
                        alert(data.error || '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ');
                });
            }
            window.onclick = function(event) {
                const modal = document.getElementById('myModal');
                const confirmModal = document.getElementById('confirmModal');
                if (event.target === modal) {
                    modal.style.display = "none";
                }
                if (event.target === confirmModal) {
                    confirmModal.style.display = "none";
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                const editBtn = document.getElementById('editProfileBtn');
                const saveBtn = document.getElementById('saveProfileBtn');
                const inputs = document.querySelectorAll('.profile-section .input-field');

                // Disable all inputs by default
                inputs.forEach(input => input.disabled = true);

                editBtn.addEventListener('click', function() {
                    inputs.forEach(input => input.disabled = false);
                    saveBtn.classList.remove('hidden');
                    editBtn.classList.add('hidden');
                });
            });
        
        
    </script>
    </body>
</html>
